{% extends "base.html" %}
{% block content %}
<h3><a href="/">Home</a> > {{dataset.name}}</h3>

<ul class="nav nav-tabs">
    {% if n_searches1 > 0 %}
    <li class="active"><a data-toggle="tab" href="#models">
        <span data-toggle="tooltip" data-placement="left" title="best models level 1">
            <i class="fa fa-sort-amount-desc" aria-hidden="true"></i>&nbsp;1</span></a></li>
    {% if best2|count > 0 %}
    <li><a data-toggle="tab" href="#ensembles">
        <span data-toggle="tooltip" data-placement="left" title="best ensemble models">
            <i class="fa fa-sort-amount-desc" aria-hidden="true"></i>&nbsp;2</span></a></li>
    {% endif %}
    <li><a data-toggle="tab" href="#pp">
        <span data-toggle="tooltip" data-placement="left" title="best pre-processing">
            <i class="fa fa-sort-amount-desc" aria-hidden="true"></i>&nbsp;P</span></a></li>
    <li><a data-toggle="tab" href="#graph">
        <span data-toggle="tooltip" data-placement="left" title="best performance graph">
            <i class="fa fa-line-chart" aria-hidden="true"></i></span></a></li>
    <li><a data-toggle="tab" href="#dataset">
        <span data-toggle="tooltip" data-placement="left" title="dataset info">
            <i class="fa fa-info-circle" aria-hidden="true"></i></span></a></li>
    {% else %}
    <li class="active"><a data-toggle="tab" href="#dataset">
        <span data-toggle="tooltip" data-placement="left" title="dataset info">
            <i class="fa fa-info-circle" aria-hidden="true"></i></span></a>
    </li>
    {% endif %}
    <li><a data-toggle="tab" href="#features">
        <span data-toggle="tooltip" data-placement="left" title="dataset features">
            <i class="fa fa-list" aria-hidden="true"></i></span></a></li>
    {% if dataset.grapher %}
    <li><a data-toggle="tab" href="#data">
        <span data-toggle="tooltip" data-placement="left" title="sample of the dataset">
            <i class="fa fa-table" aria-hidden="true"></i></span></a></li>
    <li><a data-toggle="tab" href="#data_x">
        <span data-toggle="tooltip" data-placement="left" title="graphs X / Y">
            <i class="fa fa-bar-chart" aria-hidden="true"></i>&nbsp;X</span></a></li>
    <li><a data-toggle="tab" href="#data_y">
        <span data-toggle="tooltip" data-placement="left" title="graphs Y">
            <i class="fa fa-bar-chart" aria-hidden="true"></i>&nbsp;Y</span></a></li>
    <li><a data-toggle="tab" href="#correl">
        <span data-toggle="tooltip" data-placement="left" title="correlations between features">
            <i class="fa fa-random" aria-hidden="true"></i></span></a></li>
    <li><a data-toggle="tab" href="#doc">
        <span data-toggle="tooltip" data-placement="left" title="dataset documentation">
            <i class="fa fa-file-pdf-o" aria-hidden="true"></i></span></a></li>
    {% endif %}
</ul>

<div class="tab-content">
    {% if n_searches1 > 0 %}
    <div id="models" class="tab-pane active">
        {% set best = best1 %}
        {% set n_searches = n_searches1 %}
        {% include 'models.html' %}
    </div>
    <div id="pp" class="tab-pane">
        {% include 'pp.html' %}
    </div>

    <div id="graph" class="tab-pane">
        <table>
            <tr>
                <td>
                    <img src="/get_img_dataset/{{dataset.dataset_id}};history_1?{{refresher}}"></img>
                </td>
                <td>
                    <img src="/get_img_dataset/{{dataset.dataset_id}};models_1?{{refresher}}"></img>
                </td>
            </tr>
            {% if best2|count > 0 %}
            <tr>
                <td>
                    <img src="/get_img_dataset/{{dataset.dataset_id}};history_2?{{refresher}}"></img>
                </td>
                <td>
                    <img src="/get_img_dataset/{{dataset.dataset_id}};models_2?{{refresher}}"></img>
                </td>
            </tr>
            {% endif %}
        </table>
    </div>
    {% if best2|count > 0 %}
    <div id="ensembles" class="tab-pane">
        {% set best = best2 %}
        {% set n_searches = n_searches2 %}
        {% include 'models.html' %}
    </div>
    {% endif %}
    {% endif %}
    <div id="dataset" class="tab-pane {% if n_searches1 == 0 %}active{% endif %}">
        <table class="table">
            <tr>
                <td width="50%">
                    <table class="table">
                        <tr>
                            <td><label>Name</label></td>
                            <td>{{dataset.name}}</td>
                        </tr>
                        <tr>
                            <td><label>Id</label><</td>
                            <td>{{dataset.dataset_id}}</td>
                        </tr>
                        <tr>
                            <td><label>Description</label></td>
                            <td width="80%">{{dataset.description}}</td>
                        </tr>
                        <tr>
                            <td><label>Url</label></td>
                            <td><a target="_blank" href="{{dataset.url}}">{{dataset.url}}</a></td>
                        </tr>
                        <tr>
                            <td><label>Mode</label></td>
                            <td>{{dataset.mode}}</td>
                        </tr>
                        <tr>
                            <td><label>Train set</label></td>
                            <td>{{dataset.filename_train}}</td>
                        </tr>
                        {% if dataset.filename_test != '' %}
                        <tr>
                            <td><label>Test set</label></td>
                            <td>{{dataset.filename_test}}</td>
                        </tr>
                        {% endif %}
                        {% if dataset.filename_submit != '' %}
                        <tr>
                            <td><label>Submit set</label></td>
                            <td>{{dataset.filename_submit}}</td>
                        </tr>
                        <tr>
                            <td><label>Column submit</label></td>
                            <td>{{dataset.col_submit}}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td><label>Size</label></td>
                            <td>{{dataset.size}} MB</td>
                        </tr>
                        <tr>
                            <td><label>Rows</label></td>
                            <td>{{dataset.n_rows}} K</td>
                        </tr>
                        <tr>
                            <td><label>Columns</label></td>
                            <td>{{dataset.n_cols}}</td>
                        </tr>
                        <tr>
                            <td><label>Categorical</label></td>
                            <td>{{dataset.n_cat_cols}}</td>
                        </tr>
                        <tr>
                            <td><label>Text</label></td>
                            <td>{{dataset.text_cols|count}}</td>
                        </tr>
                        <tr>
                            <td><label>Missing</label></td>
                            <td>{{dataset.n_missing}}</td>
                        </tr>
                    </table>
                </td>
                <td width="50%">
                    <table class="table">
                        <tr>
                            <td><label>Problem</label></td>
                            <td>{{dataset.problem_type}}</td>
                        </tr>
                        <tr>
                            <td><label>Target column</label></td>
                            <td>{{dataset.y_col}}</td>
                        </tr>
                        {% if dataset.problem_type == 'classification' %}
                        <tr>
                            <td><label>Number classes</td>
                            <td>{{dataset.y_n_classes}}</td>
                        </tr>
                        <tr>
                            <td><label>Classes</label></td>
                            <td>{{ print_list(dataset.y_class_names[:10]) }}</td>
                        </tr>
                        <tr>
                            <td><label>Is categorical</label></td>
                            <td>{{dataset.is_y_categorical}}</td>
                        </tr>
                        {% endif %}

                        <tr>
                            <td><label>Validation column</label></td>
                            <td>{{dataset.val_col}}</td>
                        </tr>
                        <tr>
                            <td><label>Shuffle val col</label></td>
                            <td>{{dataset.val_col_shuffle}}</td>
                        </tr>
                        <tr>
                            <td><label>Metric</label></td>
                            <td>{{dataset.metric}}</td>
                        </tr>
                        {% if dataset.other_metrics|count > 0 %}
                        <tr>
                            <td><label>other metrics</label></td>
                            <td>{{ print_list(dataset.other_metrics) }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td><label>Number of CV folds</label></td>
                            <td>{{dataset.cv_folds}}</td>
                        </tr>
                        <tr>
                            <td><label>Holdout ratio</label></td>
                            <td>
                                {% if dataset.with_test_set %}
                                Use test set
                                {% else %}
                                {{dataset.holdout_ratio * 100}} %
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><label>X columns</label></td>
                            <td width="70%">{{ print_list(dataset.x_cols) }}</td>
                        </tr>
                        <tr>
                            <td><label>Categorical columns</label></td>
                            <td width="70%">{{ print_list(dataset.cat_cols) }}</td>
                        </tr>
                        <tr>
                            <td><label>Text columns</label></td>
                            <td width="70%">{{ print_list(dataset.text_cols) }}</td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>
    <div id="features" class="tab-pane">
        {% if dataset.round_counter > 1 %}
        <p><i>NB: edit features is deactivated because the search has started</i></p>
        {% endif %}
        <table class="table table-bordered table-hover">
            <thead>
            <th>name</th>
            <th>description</th>
            <th>keep</th>
            <th>raw_type</th>
            <th>type</th>
            <th>missing</th>
            <th>unique</th>
            <th>values</th>
            {% if dataset.round_counter < 1 %}
            <th>edit</th>
            {% endif %}
            </thead>
            {% for col in dataset.features %}
            <tr>
                <td>{{col.name}}</td>
                <td>{{col.description}}</td>
                <td>
                    {% if col.to_keep %}
                    <i class="fa fa-check" style="color:green" aria-hidden="true"></i>
                    {% else %}
                    <i class="fa fa-times" style="color:red" aria-hidden="true"></i>
                    {% endif %}
                </td>
                <td>{{col.raw_type}}</td>
                <td>{{col.col_type}}</td>
                <td>{% if col.n_missing!= 0 %}{{col.n_missing}}{% endif %}</td>
                <td>{{col.n_unique_values}}</td>
                <td>{{col.first_unique_values[:200]}}{% if col.first_unique_values|count > 200 %}...{% endif %}</td>
                {% if dataset.round_counter < 1 %}
                <td>
                    <span data-toggle="tooltip" data-placement="left" title="edit feature"><a href="#EditModal"
                                                                                              class="open_EditModal"
                                                                                              style="color:inherit; text-decoration: none;"
                                                                                              data-toggle="modal"
                                                                                              data-target="#EditModal"
                                                                                              data-name="{{col.name}}"
                                                                                              data-to_keep="{{col.to_keep}}"
                                                                                              data-raw_type="{{col.raw_type}}"
                                                                                              data-col_type="{{col.col_type}}"
                                                                                              data-description="{{col.description}}"
                                                                                              style="color:inherit; text-decoration: none;">
                        <i class="fa fa-pencil-square-o"></i></a></span>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </table>
    </div>
    <div id="data" class="tab-pane">
        {% include "sample.html" %}
    </div>
    <div id="data_x" class="tab-pane">
        {% include "data.html" %}
    </div>
    <div id="data_y" class="tab-pane">
        <img src="/get_img_dataset/{{dataset.dataset_id}};hist_train_{{dataset.y_col}}?{{refresher}}"></img>
    </div>
    <div id="correl" class="tab-pane">
        <img src="/get_img_dataset/{{dataset.dataset_id}};correl?{{refresher}}"></img>
    </div>
    <div id="doc" class="tab-pane">
        <h3>Documentation</h3>
        <br>
        {% if doc_path != '' %}
        <a href="/get_doc_html/{{dataset.dataset_id}}">Download Html documentation</a>
        <br>
        <br>
        {% endif %}
        <br>
        {% if doc_pdf != '' %}
        <a href="/get_doc_pdf/{{dataset.dataset_id}}">Download PDF documentation</a>
        <br>
        <br>
        {% endif %}
        <br>
        <form action="/gendoc/{{dataset.dataset_id}}">
            <input type="submit" class="btn btn-default" value="Generate documentation"/>
        </form>
    </div>
</div>

<script type="text/javascript">
$(document).on("click", ".open_EditModal", function() {
$(".modal-body #name").val($(this).data('name'));
$(".modal-body #to_keep").val($(this).data('to_keep'));
$(".modal-body #raw_type").val($(this).data('raw_type'));
$(".modal-body #col_type").val($(this).data('col_type'));
$(".modal-body #description").val($(this).data('description'));
});



</script>

<div class="modal fade" id="EditModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Edit feature</h4>
            </div>
            <form role="form" action="/edit_feature/{{dataset.dataset_id}}" method="POST" name="request"
                  enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <div class="modal-body">
                    <div class="form-group">
                        <label>Name</label>
                        <input class="form-control" type="text" name="name" id="name" readonly>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" name="description" id="description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>To Keep ?</label>
                        {{ form.to_keep(class="form-control") }}
                    </div>
                    <div class="form-group">
                        <label>Raw type</label>
                        <input class="form-control" type="text" name="name" id="raw_type" readonly>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        {{ form.col_type(class="form-control") }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn_default" data-dismiss="modal">Cancel</button>
                    {{ form.submit }}
                    <input type="submit" class="btn btn_primary" value="Submit">
                </div>
            </form>
        </div>
    </div>
</div>

{% if n_searches1 >= 0 %}
<script>
    setInterval(function() {
      window.location.reload();
    }, 300000);


</script>
{% endif %}

<script>
    $(document).ready(function(){
    if(window.location.hash != "") {
        $('a[href="' + window.location.hash + '"]').click()
    }

});


</script>

{% endblock %}

